<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunagestio - Gesti√≥ Integral</title>
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCbzW8zQkUPH4JY9Qc-DAboH2XER_IJQjI",
            authDomain: "luna-gestion.firebaseapp.com",
            projectId: "luna-gestion",
            storageBucket: "luna-gestion.firebasestorage.app",
            messagingSenderId: "5549836438",
            appId: "1:5549836438:web:be38e0d9a3a9b458635ab7"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            console.log('‚úÖ Firebase inicialitzat correctament');
        } catch (error) {
            console.error('‚ùå Error inicialitzaci√≥ Firebase:', error);
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 1rem;
            align-items: center;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            white-space: nowrap;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
        }

        .language-selector {
            display: flex;
            gap: 0.3rem;
            background: rgba(255,255,255,0.1);
            padding: 0.3rem;
            border-radius: 8px;
        }

        .lang-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .lang-btn:hover, .lang-btn.active {
            background: #f39c12;
            transform: scale(1.05);
        }

        .auth-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn-auth {
            color: white;
            text-decoration: none;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }

        .btn-login {
            background: #27ae60;
        }

        .btn-register {
            background: #3498db;
        }

        .btn-sync {
            background: #9b59b6;
        }

        .btn-logout {
            background: #e74c3c;
        }

        .btn-notification {
            background: #e67e22;
            position: relative;
        }

        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .user-welcome {
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
        }

        /* Styles pour la notification */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Modal des messages */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h3 {
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0.5rem;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        .message-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .message-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3498db;
            transition: all 0.3s;
        }

        .message-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .message-item.unread {
            background: #e8f4fd;
            border-left-color: #e74c3c;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .message-sender {
            font-weight: bold;
            color: #2c3e50;
        }

        .message-date {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .message-subject {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .message-content {
            color: #34495e;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .message-type {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .message-type.confirmation { background: #27ae60; }
        .message-type.cancellation { background: #e74c3c; }
        .message-type.information { background: #3498db; }
        .message-type.reminder { background: #f39c12; }
        .message-type.other { background: #9b59b6; }

        .no-messages {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .no-messages i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8rem 1rem 4rem;
            text-align: center;
            margin-top: 60px;
        }

        .hero-content h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero-content p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .btn {
            background: #f39c12;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .services {
            padding: 4rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-title {
            text-align: center;
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 3rem;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .service-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .service-card:hover {
            transform: translateY(-5px);
        }

        .service-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .service-card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .service-description {
            color: #7f8c8d;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .service-features {
            list-style: none;
        }

        .service-features li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #ecf0f1;
            color: #34495e;
        }

        .service-features li:before {
            content: "‚úì";
            color: #27ae60;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .appointment-section {
            background: #ecf0f1;
            padding: 4rem 1rem;
        }

        .appointment-form {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #3498db;
            outline: none;
        }

        .availability-info {
            background: #e8f4fd;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #3498db;
        }

        .appointment-query-section {
            padding: 4rem 1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .contact-info {
            padding: 4rem 1rem;
            background: #2c3e50;
            color: white;
        }

        .contact-grid {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .contact-card {
            text-align: center;
            padding: 2rem;
        }

        .contact-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #3498db;
        }

        .footer {
            background: #34495e;
            color: white;
            text-align: center;
            padding: 2rem 1rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: #2c3e50;
                flex-direction: column;
                padding: 1rem;
            }

            .nav-links.active {
                display: flex;
            }

            .hero-content h1 {
                font-size: 2rem;
            }

            .section-title {
                font-size: 2rem;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <span data-i18n="nav.logo">Lunagestio</span>
            </div>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>

            <ul class="nav-links">
                <li><a href="#inici" data-i18n="nav.home">Inici</a></li>
                <li><a href="#serveis" data-i18n="nav.services">Serveis</a></li>
                <li><a href="#contacte" data-i18n="nav.contact">Contacte</a></li>
                <li><a href="#cites" data-i18n="nav.appointment">Cites</a></li>
                
                <!-- Selector d'idioma -->
                <li class="language-selector">
                    <button class="lang-btn active" data-lang="ca">CA</button>
                    <button class="lang-btn" data-lang="es">ES</button>
                    <button class="lang-btn" data-lang="fr">FR</button>
                    <button class="lang-btn" data-lang="en">EN</button>
                </li>
                
                <!-- Botons d'autenticaci√≥ (din√†mic) -->
                <li class="auth-buttons" id="authButtonsContainer">
                    <!-- Contingut carregat din√†micament -->
                </li>
            </ul>
        </nav>
    </header>

    <!-- Modal des messages -->
    <div id="messagesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="messages.title">Missatges Rebuts</h3>
                <button class="close-modal" onclick="closeMessagesModal()">&times;</button>
            </div>
            <div id="messagesList" class="message-list">
                <!-- Messages charg√©s dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Secci√≥ Hero -->
    <section class="hero" id="inici">
        <div class="hero-content">
            <h1 data-i18n="hero.title">Lunagestio - El Vostre Soci de Confian√ßa</h1>
            <p data-i18n="hero.subtitle">Serveis integrals de gesti√≥: Estrangeria, Fiscalitat, Comptabilitat i m√©s</p>
            <button class="btn" onclick="scrollToSection('cites')">
                <i class="fas fa-calendar-check"></i> <span data-i18n="hero.cta">Sol¬∑licitar Cita</span>
            </button>
        </div>
    </section>

    <!-- Secci√≥ Serveis -->
    <section class="services" id="serveis">
        <h2 class="section-title" data-i18n="services.title">Els Nostres Serveis</h2>
        <div class="services-grid">
            <!-- Servei d'Estrangeria -->
            <div class="service-card">
                <div class="service-icon">üåç</div>
                <h3 data-i18n="services.foreign.title">Estrangeria</h3>
                <p class="service-description" data-i18n="services.foreign.description">
                    Gesti√≥ completa de tr√†mits d'estrangeria per a residents internacionals. 
                    Assessorament especialitzat en permisos de resid√®ncia, treball, nacionalitat espanyola, 
                    reagrupaci√≥ familiar i traduccions jurades.
                </p>
                <ul class="service-features">
                    <li data-i18n="services.foreign.feature1">Permisos de resid√®ncia i treball</li>
                    <li data-i18n="services.foreign.feature2">Nacionalitat espanyola</li>
                    <li data-i18n="services.foreign.feature3">Reagrupaci√≥ familiar</li>
                    <li data-i18n="services.foreign.feature4">Traduccions jurades</li>
                    <li data-i18n="services.foreign.feature5">Assessorament legal migratori</li>
                </ul>
            </div>

            <!-- Servei Fiscal -->
            <div class="service-card">
                <div class="service-icon">üíº</div>
                <h3 data-i18n="services.labor.title">Fiscal / Comptable</h3>
                <p class="service-description" data-i18n="services.labor.description">
                    Solucions integrals per a empreses i aut√≤noms. Gesti√≥ de tota la 
                    documentaci√≥, n√≤mines, contractes, inscripcions a la Seguretat Social, 
                    aix√≠ com declaracions d'impostos i obligacions fiscals.
                </p>
                <ul class="service-features">
                    <li data-i18n="services.labor.feature1">Gesti√≥ de n√≤mines i contractes</li>
                    <li data-i18n="services.labor.feature2">Inscripcions Seguretat Social</li>
                    <li data-i18n="services.labor.feature3">Declaracions d'impostos</li>
                    <li data-i18n="services.labor.feature4">Assessorament fiscal</li>
                    <li data-i18n="services.labor.feature5">Comptabilitat per a empreses</li>
                </ul>
            </div>

            <!-- Servei d'Assegurances -->
            <div class="service-card">
                <div class="service-icon">üõ°Ô∏è</div>
                <h3 data-i18n="services.insurance.title">Assegurances</h3>
                <p class="service-description" data-i18n="services.insurance.description">
                    Trobeu les millors cobertures d'assegurances adaptades a les vostres necessitats espec√≠fiques. 
                    Treballem amb les principals companyies per oferir-vos assegurances 
                    d'habitatge, salut, vida, autom√≤bil i responsabilitat civil.
                </p>
                <ul class="service-features">
                    <li data-i18n="services.insurance.feature1">Assegurances d'habitatge</li>
                    <li data-i18n="services.insurance.feature2">Assegurances de salut i vida</li>
                    <li data-i18n="services.insurance.feature3">Assegurances d'autom√≤bil</li>
                    <li data-i18n="services.insurance.feature4">Responsabilitat civil</li>
                    <li data-i18n="services.insurance.feature5">Comparaci√≥ de companyies</li>
                </ul>
            </div>

            <!-- Servei Vehicles -->
            <div class="service-card">
                <div class="service-icon">üöó</div>
                <h3 data-i18n="services.vehicles.title">Vehicles</h3>
                <p class="service-description" data-i18n="services.vehicles.description">
                    Gesti√≥ de tots els tr√†mits relacionats amb el vostre vehicle de manera r√†pida i eficient. 
                    Des de transfer√®ncies i matriculacions fins a la ITV i permisos de circulaci√≥.
                </p>
                <ul class="service-features">
                    <li data-i18n="services.vehicles.feature1">Transfer√®ncies de vehicles</li>
                    <li data-i18n="services.vehicles.feature2">Matriculacions i ITV</li>
                    <li data-i18n="services.vehicles.feature3">Permisos de circulaci√≥</li>
                    <li data-i18n="services.vehicles.feature4">Baixes temporals/definitives</li>
                    <li data-i18n="services.vehicles.feature5">Gesti√≥ de multes</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Secci√≥ Cites -->
    <section class="appointment-section" id="cites">
        <h2 class="section-title" data-i18n="appointment.title">Sol¬∑licitar una Cita</h2>
        <p data-i18n="appointment.subtitle">Reserveu la vostra consulta en l√≠nia</p>
        
        <div class="appointment-form">
            <div class="availability-info">
                <h4><i class="fas fa-info-circle"></i> <span data-i18n="availability.title">Horaris Disponibles</span></h4>
                <p data-i18n="availability.schedule">Dilluns-Dimarts: 10h-13h i 16h-19h | Dimecres-Divendres: 10h-15h</p>
                <p data-i18n="availability.closed">Tancat: caps de setmana i festius</p>
            </div>
            
            <div id="appointmentAuthCheck">
                <!-- Verificaci√≥ de connexi√≥ -->
            </div>
            
            <form id="appointmentForm" style="display: none;">
                <div class="form-group">
                    <label for="service" data-i18n="form.service">Servei sol¬∑licitat *</label>
                    <select id="service" required>
                        <option value="" data-i18n="form.selectService">Seleccioneu un servei</option>
                        <option value="extranjeria" data-i18n="services.foreign.title">Estrangeria</option>
                        <option value="laboral" data-i18n="services.labor.title">Fiscal / Comptable</option>
                        <option value="seguros" data-i18n="services.insurance.title">Assegurances</option>
                        <option value="vehiculos" data-i18n="services.vehicles.title">Vehicles</option>
                        <option value="otro" data-i18n="form.other">Altres</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="appointmentDate" data-i18n="form.selectDate">Data desitjada *</label>
                    <input type="date" id="appointmentDate" required>
                </div>
                
                <div class="form-group">
                    <label for="appointmentTime" data-i18n="form.selectTime">Hora *</label>
                    <select id="appointmentTime" required>
                        <option value="" data-i18n="form.selectTime">Seleccioneu una hora</option>
                        <!-- Els horaris es generaran din√†micament -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="message" data-i18n="form.message">Missatge (opcional)</label>
                    <textarea id="message" rows="4" data-i18n="form.messagePlaceholder" placeholder="Informaci√≥ addicional sobre la vostra consulta..."></textarea>
                </div>
                
                <button type="submit" class="btn" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> <span data-i18n="form.submit">Confirmar la Cita</span>
                </button>
            </form>
        </div>
    </section>

    <!-- Consulta de Cites -->
    <section class="appointment-query-section" id="consulta-cites">
        <div class="appointment-form">
            <h2 data-i18n="query.title">Consultar les Vostres Cites</h2>
            <p data-i18n="query.subtitle">Verifiqueu l'estat de les vostres cites programades</p>
            
            <div class="form-group">
                <label for="queryEmail" data-i18n="query.email">Email *</label>
                <input type="email" id="queryEmail" required data-i18n="query.emailPlaceholder" placeholder="Introdu√Øu l'email utilitzat per a la reserva">
            </div>
            
            <button class="btn btn-secondary" onclick="queryAppointments()" id="queryBtn">
                <i class="fas fa-search"></i> <span data-i18n="query.button">Consultar Cites</span>
            </button>
            
            <div id="appointmentsResults" style="margin-top: 2rem;"></div>
        </div>
    </section>

    <!-- Secci√≥ Contacte -->
    <section class="contact-info" id="contacte">
        <h2 class="section-title" data-i18n="contact.title">Contacte</h2>
        <div class="contact-grid">
            <div class="contact-card">
                <i class="fas fa-map-marker-alt"></i>
                <h3 data-i18n="contact.address">Adre√ßa</h3>
                <p>C/ Sant Marti 17<br>Palafrugell, Spain, 17200</p>
            </div>
            <div class="contact-card">
                <i class="fas fa-phone"></i>
                <h3 data-i18n="contact.phone">Tel√®fon</h3>
                <p>+34 972 30 43 09<br>640 56 48 54 / 678 13 94 21</p>
            </div>
            <div class="contact-card">
                <i class="fas fa-envelope"></i>
                <h3 data-i18n="contact.email">Email</h3>
                <p>info@lunagestio.com</p>
            </div>
            <div class="contact-card">
                <i class="fas fa-clock"></i>
                <h3 data-i18n="contact.hours.title">Horari</h3>
                <p data-i18n="contact.hours.monday">Dilluns-Dimarts: 10h-13h i 16h-19h</p>
                <p data-i18n="contact.hours.wednesday">Dimecres-Divendres: 10h-15h</p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 Lunagestio. <span data-i18n="footer.rights">Tots els drets reservats.</span></p>
        <p style="margin-top: 1rem; opacity: 0.8;">
            <i class="fas fa-shield-alt"></i> <span data-i18n="footer.privacy">La vostra privadesa √©s important per a nosaltres</span>
        </p>
    </footer>

    <!-- Scripts -->
    <script type="module" src="./sync-manager.js"></script>

    <script>
        // ===== SISTEMA DE TRADUCCIONS COMPLET =====
        const translations = {
            ca: {
                "nav.logo": "Lunagestio",
                "nav.home": "Inici",
                "nav.services": "Serveis",
                "nav.contact": "Contacte",
                "nav.appointment": "Cites",
                
                "auth.login": "Iniciar sessi√≥",
                "auth.register": "Registre",
                "auth.logout": "Tancar sessi√≥",
                "auth.sync": "Sincronitzar",
                "auth.welcome": "Hola",
                "auth.notifications": "Notificacions",
                "auth.adminMode": "Mode Administrador",
                "auth.adminMessage": "Esteu connectat com a administrador. Per sol¬∑licitar una cita, utilitzeu un compte de client.",
                "auth.changeAccount": "Canviar de compte",
                "auth.connected": "Connectat",
                "auth.canBook": "Ara podeu sol¬∑licitar una cita.",
                "auth.loginRequired": "Connexi√≥ Requerida",
                "auth.loginMessage": "Heu d'estar connectat per sol¬∑licitar una cita.",
                
                "messages.title": "Missatges Rebuts",
                "messages.noMessages": "No teniu cap missatge nou",
                "messages.from": "De",
                "messages.date": "Data",
                "messages.type": "Tipus",
                "messages.confirmation": "Confirmaci√≥",
                "messages.cancellation": "Cancel¬∑laci√≥",
                "messages.information": "Informaci√≥",
                "messages.reminder": "Recordatori",
                "messages.other": "Altres",
                "messages.unread": "No llegit",
                
                "hero.title": "Lunagestio - El Vostre Soci de Confian√ßa",
                "hero.subtitle": "Serveis integrals de gesti√≥: Estrangeria, Fiscalitat, Comptabilitat i m√©s",
                "hero.cta": "Sol¬∑licitar Cita",
                
                "services.title": "Els Nostres Serveis",
                "services.foreign.title": "Estrangeria",
                "services.foreign.description": "Gesti√≥ completa de tr√†mits d'estrangeria per a residents internacionals.",
                "services.foreign.feature1": "Permisos de resid√®ncia i treball",
                "services.foreign.feature2": "Nacionalitat espanyola",
                "services.foreign.feature3": "Reagrupaci√≥ familiar",
                "services.foreign.feature4": "Traduccions jurades",
                "services.foreign.feature5": "Assessorament legal migratori",
                
                // ... (autres traductions restent les m√™mes)
            },
            es: {
                "nav.logo": "Lunagestio",
                "nav.home": "Inicio",
                "nav.services": "Servicios",
                "nav.contact": "Contacto",
                "nav.appointment": "Citas",
                
                "auth.login": "Iniciar sesi√≥n",
                "auth.register": "Registro",
                "auth.logout": "Cerrar sesi√≥n",
                "auth.sync": "Sincronizar",
                "auth.welcome": "Hola",
                "auth.notifications": "Notificaciones",
                "auth.adminMode": "Modo Administrador",
                "auth.adminMessage": "Est√° conectado como administrador. Para solicitar una cita, utilice una cuenta de cliente.",
                "auth.changeAccount": "Cambiar de cuenta",
                "auth.connected": "Conectado",
                "auth.canBook": "Ahora puede solicitar una cita.",
                "auth.loginRequired": "Conexi√≥n Requerida",
                "auth.loginMessage": "Debe estar conectado para solicitar una cita.",
                
                "messages.title": "Mensajes Recibidos",
                "messages.noMessages": "No tiene ning√∫n mensaje nuevo",
                "messages.from": "De",
                "messages.date": "Fecha",
                "messages.type": "Tipo",
                "messages.confirmation": "Confirmaci√≥n",
                "messages.cancellation": "Cancelaci√≥n",
                "messages.information": "Informaci√≥n",
                "messages.reminder": "Recordatorio",
                "messages.other": "Otros",
                "messages.unread": "No le√≠do",
                
                "hero.title": "Lunagestio - Su Socio de Confianza",
                "hero.subtitle": "Servicios integrales de gesti√≥n: Extranjer√≠a, Fiscalidad, Contabilidad y m√°s",
                "hero.cta": "Solicitar Cita",
                
                // ... (autres traductions restent les m√™mes)
            },
            fr: {
                "nav.logo": "Lunagestio",
                "nav.home": "Accueil",
                "nav.services": "Services",
                "nav.contact": "Contact",
                "nav.appointment": "Rendez-vous",
                
                "auth.login": "Connexion",
                "auth.register": "Inscription",
                "auth.logout": "D√©connexion",
                "auth.sync": "Synchroniser",
                "auth.welcome": "Bonjour",
                "auth.notifications": "Notifications",
                "auth.adminMode": "Mode Administrateur",
                "auth.adminMessage": "Vous √™tes connect√© en tant qu'administrateur. Pour prendre un rendez-vous, utilisez un compte client.",
                "auth.changeAccount": "Changer de compte",
                "auth.connected": "Connect√©",
                "auth.canBook": "Vous pouvez maintenant prendre un rendez-vous.",
                "auth.loginRequired": "Connexion Requise",
                "auth.loginMessage": "Vous devez √™tre connect√© pour prendre un rendez-vous.",
                
                "messages.title": "Messages Re√ßus",
                "messages.noMessages": "Vous n'avez aucun nouveau message",
                "messages.from": "De",
                "messages.date": "Date",
                "messages.type": "Type",
                "messages.confirmation": "Confirmation",
                "messages.cancellation": "Annulation",
                "messages.information": "Information",
                "messages.reminder": "Rappel",
                "messages.other": "Autres",
                "messages.unread": "Non lu",
                
                "hero.title": "Lunagestio - Votre Partenaire de Confiance",
                "hero.subtitle": "Services complets de gestion : √âtrang√©rie, Fiscalit√©, Comptabilit√© et plus",
                "hero.cta": "Prendre Rendez-vous",
                
                // ... (autres traductions restent les m√™mes)
            },
            en: {
                "nav.logo": "Lunagestio",
                "nav.home": "Home",
                "nav.services": "Services",
                "nav.contact": "Contact",
                "nav.appointment": "Appointments",
                
                "auth.login": "Login",
                "auth.register": "Register",
                "auth.logout": "Logout",
                "auth.sync": "Sync",
                "auth.welcome": "Hello",
                "auth.notifications": "Notifications",
                "auth.adminMode": "Admin Mode",
                "auth.adminMessage": "You are logged in as administrator. To book an appointment, use a client account.",
                "auth.changeAccount": "Change account",
                "auth.connected": "Connected",
                "auth.canBook": "You can now book an appointment.",
                "auth.loginRequired": "Login Required",
                "auth.loginMessage": "You must be logged in to book an appointment.",
                
                "messages.title": "Received Messages",
                "messages.noMessages": "You have no new messages",
                "messages.from": "From",
                "messages.date": "Date",
                "messages.type": "Type",
                "messages.confirmation": "Confirmation",
                "messages.cancellation": "Cancellation",
                "messages.information": "Information",
                "messages.reminder": "Reminder",
                "messages.other": "Other",
                "messages.unread": "Unread",
                
                "hero.title": "Lunagestio - Your Trusted Partner",
                "hero.subtitle": "Comprehensive management services: Foreign Affairs, Taxation, Accounting and more",
                "hero.cta": "Request Appointment",
                
                // ... (autres traductions restent les m√™mes)
            }
        };

        // ===== GESTIONADOR FIREBASE =====
        const FirebaseManager = {
            // Guardar una cita
            saveAppointment: async function(appointment) {
                try {
                    const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                    
                    const docRef = await addDoc(collection(window.db, 'appointments'), {
                        ...appointment,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    
                    console.log('‚úÖ Cita guardada correctamente con ID:', docRef.id);
                    return { ...appointment, id: docRef.id };
                } catch (error) {
                    console.error('‚ùå Error guardando en Firebase:', error);
                    throw error;
                }
            },

            // Obtener citas por email
            getAppointmentsByEmail: async function(email) {
                try {
                    const { collection, query, where, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                    
                    const q = query(
                        collection(window.db, 'appointments'),
                        where('userEmail', '==', email.toLowerCase()),
                        orderBy('date'),
                        orderBy('time')
                    );
                    
                    const snapshot = await getDocs(q);
                    const appointments = [];
                    snapshot.forEach(doc => {
                        appointments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    console.log('üì• Citas recuperadas:', appointments.length);
                    return appointments;
                } catch (error) {
                    console.error('‚ùå Error recuperando de Firebase:', error);
                    throw error;
                }
            },

            // Obtener mensajes del usuario
            getUserMessages: async function(userId) {
                try {
                    const { collection, query, where, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                    
                    const q = query(
                        collection(window.db, 'messages'),
                        where('userId', '==', userId),
                        orderBy('createdAt', 'desc')
                    );
                    
                    const snapshot = await getDocs(q);
                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    console.log('üì® Mensajes recuperados:', messages.length);
                    return messages;
                } catch (error) {
                    console.error('‚ùå Error recuperando mensajes:', error);
                    return [];
                }
            },

            // Marcar mensaje como le√≠do
            markMessageAsRead: async function(messageId) {
                try {
                    const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js');
                    await updateDoc(doc(window.db, 'messages', messageId), {
                        read: true,
                        readAt: serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('‚ùå Error marcando mensaje como le√≠do:', error);
                    return false;
                }
            }
        };

        // ===== GESTIONADOR DE USUARIOS =====
        const UserManager = {
            getCurrentUser: () => {
                return JSON.parse(localStorage.getItem('lunagestio_current_user'));
            },

            setCurrentUser: (user) => {
                localStorage.setItem('lunagestio_current_user', JSON.stringify(user));
            },

            logout: () => {
                localStorage.removeItem('lunagestio_current_user');
            }
        };

        // ===== VARIABLES GLOBALES =====
        let currentLang = 'ca';
        let unreadMessagesCount = 0;
        let messagesCheckInterval = null;

        // ===== SISTEMA DE NOTIFICATIONS =====

        // Charger les messages de l'utilisateur
        async function loadUserMessages() {
            const currentUser = UserManager.getCurrentUser();
            if (!currentUser) return;

            try {
                const messages = await FirebaseManager.getUserMessages(currentUser.id);
                updateUnreadMessagesCount(messages);
                return messages;
            } catch (error) {
                console.error('Error cargando mensajes:', error);
                return [];
            }
        }

        // Mettre √† jour le compteur de messages non lus
        function updateUnreadMessagesCount(messages) {
            unreadMessagesCount = messages.filter(msg => !msg.read).length;
            updateNotificationBadge();
        }

        // Mettre √† jour le badge de notification
        function updateNotificationBadge() {
            const notificationBtn = document.getElementById('notificationBtn');
            if (notificationBtn) {
                const badge = notificationBtn.querySelector('.notification-badge');
                if (unreadMessagesCount > 0) {
                    if (!badge) {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'notification-badge';
                        newBadge.textContent = unreadMessagesCount > 9 ? '9+' : unreadMessagesCount;
                        notificationBtn.appendChild(newBadge);
                    } else {
                        badge.textContent = unreadMessagesCount > 9 ? '9+' : unreadMessagesCount;
                    }
                } else if (badge) {
                    badge.remove();
                }
            }
        }

        // Ouvrir le modal des messages
        async function openMessagesModal() {
            const messages = await loadUserMessages();
            displayMessages(messages);
            document.getElementById('messagesModal').style.display = 'block';
        }

        // Fermer le modal des messages
        function closeMessagesModal() {
            document.getElementById('messagesModal').style.display = 'none';
        }

        // Afficher les messages dans le modal
        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="no-messages">
                        <i class="fas fa-envelope-open"></i>
                        <h3 data-i18n="messages.noMessages">No teniu cap missatge nou</h3>
                        <p>${translations[currentLang]?.["messages.noMessages"] || 'You have no new messages'}</p>
                    </div>
                `;
                return;
            }

            messagesList.innerHTML = messages.map(message => {
                const messageDate = message.createdAt?.toDate ? message.createdAt.toDate() : new Date(message.createdAt);
                const isUnread = !message.read;
                
                return `
                    <div class="message-item ${isUnread ? 'unread' : ''}" onclick="openMessage('${message.id}')">
                        <div class="message-header">
                            <div>
                                <div class="message-sender">${translations[currentLang]?.["messages.from"] || 'From'}: Lunagestio</div>
                                <div class="message-date">${formatDateTime(messageDate)}</div>
                            </div>
                            <span class="message-type ${message.type}">
                                ${getMessageTypeText(message.type)}
                            </span>
                        </div>
                        <div class="message-subject">${message.subject}</div>
                        <div class="message-content">${message.content}</div>
                        ${isUnread ? `
                            <div style="color: #e74c3c; font-weight: bold; font-size: 0.9rem;">
                                <i class="fas fa-circle"></i> ${translations[currentLang]?.["messages.unread"] || 'Unread'}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            changeLanguage(currentLang);
        }

        // Ouvrir un message sp√©cifique
        async function openMessage(messageId) {
            // Marquer comme lu
            await FirebaseManager.markMessageAsRead(messageId);
            
            // Recharger les messages
            const messages = await loadUserMessages();
            displayMessages(messages);
        }

        // Obtenir le texte du type de message
        function getMessageTypeText(type) {
            const types = {
                'confirmation': translations[currentLang]?.["messages.confirmation"] || 'Confirmation',
                'cancellation': translations[currentLang]?.["messages.cancellation"] || 'Cancellation',
                'information': translations[currentLang]?.["messages.information"] || 'Information',
                'reminder': translations[currentLang]?.["messages.reminder"] || 'Reminder',
                'other': translations[currentLang]?.["messages.other"] || 'Other'
            };
            return types[type] || type;
        }

        // Format de date et heure
        function formatDateTime(date) {
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            const locales = {
                'ca': 'ca-ES',
                'es': 'es-ES',
                'fr': 'fr-FR',
                'en': 'en-US'
            };
            
            return date.toLocaleString(locales[currentLang] || 'ca-ES', options);
        }

        // ===== FONCTIONS EXISTANTES (adapt√©es) =====

        // GESTI√ìN DE AUTENTICACI√ìN - MISE √Ä JOUR AVEC NOTIFICATIONS
        function updateAuthButtons() {
            const container = document.getElementById('authButtonsContainer');
            const currentUser = UserManager.getCurrentUser();
            
            if (currentUser) {
                const welcomeText = translations[currentLang]?.["auth.welcome"] || 'Hello';
                const syncText = translations[currentLang]?.["auth.sync"] || 'Sync';
                const logoutText = translations[currentLang]?.["auth.logout"] || 'Logout';
                const notificationsText = translations[currentLang]?.["auth.notifications"] || 'Notifications';
                
                container.innerHTML = `
                    <span class="user-welcome">
                        <i class="fas fa-user-circle"></i>
                        ${welcomeText} ${currentUser.firstName}
                    </span>
                    <button onclick="syncData()" class="btn-auth btn-sync" title="${syncText}">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button onclick="openMessagesModal()" class="btn-auth btn-notification" title="${notificationsText}" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        ${unreadMessagesCount > 0 ? `<span class="notification-badge">${unreadMessagesCount > 9 ? '9+' : unreadMessagesCount}</span>` : ''}
                    </button>
                    <button onclick="logout()" class="btn-auth btn-logout">
                        <i class="fas fa-sign-out-alt"></i> ${logoutText}
                    </button>
                `;
            } else {
                container.innerHTML = `
                    <a href="login.html" class="btn-auth btn-login">
                        <i class="fas fa-sign-in-alt"></i> <span data-i18n="auth.login">Iniciar sessi√≥</span>
                    </a>
                    <a href="register.html" class="btn-auth btn-register">
                        <i class="fas fa-user-plus"></i> <span data-i18n="auth.register">Registre</span>
                    </a>
                `;
            }
            
            changeLanguage(currentLang);
        }

        // V√©rification p√©riodique des nouveaux messages
        function startMessagesPolling() {
            if (messagesCheckInterval) {
                clearInterval(messagesCheckInterval);
            }
            
            messagesCheckInterval = setInterval(async () => {
                const currentUser = UserManager.getCurrentUser();
                if (currentUser) {
                    await loadUserMessages();
                }
            }, 30000); // V√©rifier toutes les 30 secondes
        }

        // Arr√™ter la v√©rification des messages
        function stopMessagesPolling() {
            if (messagesCheckInterval) {
                clearInterval(messagesCheckInterval);
                messagesCheckInterval = null;
            }
        }

        // ===== INITIALISATION MISE √Ä JOUR =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializar traducciones con catal√°n por defecto
            changeLanguage('ca');
            
            // A√±adir event listeners para los botones de idioma
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    changeLanguage(this.getAttribute('data-lang'));
                });
            });

            // Actualizar botones de autenticaci√≥n
            updateAuthButtons();
            
            // Verificar autenticaci√≥n para citas
            checkAppointmentAuth();
            
            // Configurar fecha m√≠nima
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = today;
            
            // Configurar horarios
            configureTimeSlots();
            
            // Charger les messages si l'utilisateur est connect√©
            const currentUser = UserManager.getCurrentUser();
            if (currentUser) {
                await loadUserMessages();
                startMessagesPolling();
            }
            
            console.log('üöÄ Sitio Lunagestio cargado - Con sistema de notificaciones');
        });

        // Fermer le modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('messagesModal');
            if (event.target === modal) {
                closeMessagesModal();
            }
        }

        // Arr√™ter la v√©rification des messages lors de la d√©connexion
        async function logout() {
            const confirmMessage = 
                currentLang === 'ca' ? 'Esteu segur que voleu tancar la sessi√≥?' :
                currentLang === 'es' ? '¬øEst√°s seguro de que quieres cerrar sesi√≥n?' :
                currentLang === 'fr' ? '√ätes-vous s√ªr de vouloir vous d√©connecter ?' :
                'Are you sure you want to log out?';
            
            if (confirm(confirmMessage)) {
                stopMessagesPolling();
                
                // Sincronizar antes de desconectar
                if (window.SyncManager) {
                    await window.SyncManager.quickSync();
                }
                
                UserManager.logout();
                updateAuthButtons();
                checkAppointmentAuth();
                
                showMessage(
                    currentLang === 'ca' ? 'Sessi√≥ tancada correctament' :
                    currentLang === 'es' ? 'Sesi√≥n cerrada correctamente' :
                    currentLang === 'fr' ? 'D√©connexion r√©ussie' :
                    'Logout successful', 
                    'success'
                );
            }
        }

        // ... (le reste des fonctions existantes reste inchang√©)
    </script>
</body>
</html>
